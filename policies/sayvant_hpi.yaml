version: "2.0"

retriever: semantic

retriever_config:
  contextualize_claims: true
  claim_prefixes:
    chief_complaint: "The patient's chief complaint is: "
    mode_of_transport: "The patient arrived via: "
    dx: "The diagnosis is: "
    medications: "The patient takes: "
    hpi: "The patient's history: "
  chunk_size: 200
  overlap: 50
  context_window: 150
  context_expansion:
    enabled: true
    max_context_length: 200
    terse_threshold: 3
    field_relationships:
      chief_complaint:
        context_fields: ['hpi']
      dx:
        context_fields: ['hpi', 'ddx']

validators:
  hpi:
    - bm25_validator

  medications:
    - bm25_validator

  dx:
    - bm25_validator

  treatments:
    - bm25_validator

  procedures_by_me:
    - bm25_validator

  procedures_by_others:
    - bm25_validator

  ddx:
    - bm25_validator

  pe_findings:
    - bm25_validator

  chief_complaint:
    - hybrid_bm25_minilm_validator

  identifiers:
    - regex_validator

  pmh:
    - hybrid_bm25_minilm_validator

  psh:
    - negation_refuter:
        match_threshold: 0.6
        semantic_threshold: 0.6
        boost_words:
          - surgery
          - surgical
          - procedure
          - operation
          - surgical history
    - nli_validator

  mode_of_transport:
    - hybrid_bm25_minilm_validator:
        min_evidence_score: 0.5
        boost_terms:
              - ambulance
              # - walked
              # - on foot
              - private vehicle
              - police
              - wheelchair
        literal_boost: 0.2

  historians:
    - speaker_attribution_validator

  dispo:
    - regex_validator

  follow_up:
    - bm25_validator

  imaging_interpreted:
    - bm25_validator

  pt_family_discussion:
    - regex_validator

  code_status:
    - minilm_validator

  social:
    - minilm_validator

  treatments_pta:
    - bm25_validator

settings:
  fail_fast: false
  min_evidence_score: 0.3
  max_evidence_spans: 5
  context_boost: 0.3
  embedding_threshold: 0.65
  bm25_weight: 0.5

# Aggregation strategy with weighted voting (for fields with multiple validators)
aggregation:
  strategy: "weighted_voting"
  default_weights:
    bm25_validator: 0.6
    hybrid_bm25_minilm_validator: 0.7
    nli_validator: 0.3
    negation_refuter: 0.8
    minilm_validator: 0.5
    regex_validator: 1.0
    speaker_attribution_validator: 1.0
  explain_conflicts: true

# Quality analysis modules (apply to all fields)
quality_modules:
  # NOTE: semantic_quality disabled due to false positives with structured summaries
  # - name: semantic_quality
  #   min_quality_score: 0.95
  #   min_confidence: 0.75
  #   analyze_insufficient: true
  #   max_issues: 3
  #   min_phrase_length: 2
  
  - name: temporal_numeric_drift
    min_quality_score: 1.1       # Always analyze (set > 1.0 to always trigger)
    tolerance_percent: 10        # Allow 10% numeric difference
    check_temporal: true         # Check temporal adverbs (e.g., "this morning")
    check_numeric: true          # Check numeric values (e.g., "6 years" vs "4 years")
    max_issues: 3                # Report up to 3 issues per claim

# Confidence penalty for quality issues
quality_confidence_penalty: 0.9  # Multiply confidence by 0.9 when drift detected

# Scoring configuration
scoring:
  method: "quality_weighted"  # Weight each claim by its quality_score
  # This ensures low-quality claims (with drift/issues) reduce the overall score
